---
title: "Expert advice from experts"
author:
- familyname: Curie
  othernames: Marie
  address: University of Paris
  email: mcurie.notreal@gmail.com
  correspondingauthor: true
  qualifications: Nobel Prize, PhD
- familyname: Curie
  othernames: Pierre
  address: University of Paris
  qualifications: Nobel Prize, PhD
department: Department of\newline Econometrics &\newline Business Statistics
organization: Acme Corporation
bibliography: references.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, messages=FALSE, warning=FALSE)
# Make sure you have the latest versions of rmarkdown and bookdown installed
library(dplyr)
library(ggplot2)
library(tidyverse)
library(plotly)
library(mclust)
```

# Introduction

Principal component analysis (PCA) plays an important role in the evaluation of the stock price. By utilising the small number of the principle components to explain the general variation in the original data. This report will apply the PCA method to address whether it is a good measurement in the stock pricing. By investigating the measurement of stock value and stock risk to further find our the potential limitation that PCA might face. We will also compare the performance of PCA with another method which is Clustering Analysis to check the accuracy of our result. 


In financial market, the value of stocks would be investigated by many different variables. However, the large number of variables of each stock might make readers hard to make the comparison. Therefore, principal component analysis (PCA) would be utilised to help with evaluating stocks. PCA plays an important role in the evaluation of the stock price, which help combine many variables into a index, and the index of each stock would be a element to help with evaluation. This report would focus on the PCA, as well as the clustering analysis, to analysis all the stock in the dataset. Meanwhile, arising useful suggestions among all stocks. In addition, the limitation of the analysis would be pointed out.



# Data Description
```{r data}
stocks_ori <- read_csv("stocks.csv")
#nrow(stocks)
#head(stocks)
stocks <- na.omit(stocks_ori)%>%
  rename(intra_day=`Market cap (intra-day)`,
         ent_value=`Enterprise value`,
         trail_pe=`Trailing P/E`,
         for_pe=`Forward P/E`,
         peg=`PEG ratio (5-yr expected)`,
         ttm=`Price/sales (ttm)`,
         mrq=`Price/book (mrq)`,
         rev=`Enterprise value/revenue`,
         ebitda=`Enterprise value/EBITDA`,
         tot_risk = `Total ESG risk score`,
         envir_risk = `Environmental Risk Score`,
         social_risk = `Social Risk Score`,
         gover_risk = `Governance Risk Score`)
  
#stocks <- na.omit(stocks)
#nrow(stocks)
#glimpse(stocks_ori)


#nrow(stocks)
#head(stocks)
#stocks <- na.omit(stocks)
#nrow(stocks)
#stocks_ori <- stocks_ori%>%
#  rename(intra_day=`Market cap (intra-day)`,
#         ent_value=`Enterprise value`,
#         trail_pe=`Trailing P/E`,
#         for_pe=`Forward P/E`,
#         peg=`PEG ratio (5-yr expected)`,
#         ttm=`Price/sales (ttm)`,
#         mrq=`Price/book (mrq)`,
#         rev=`Enterprise value/revenue`,
#         ebitda=`Enterprise value/EBITDA`,
#         tot_risk = `Total ESG risk score`,
#         envir_risk = `Environmental Risk Score`,
#         social_risk = `Social Risk Score`,
#         gover_risk = `Governance Risk Score`)

```

The data which used in this report was sourced from [Yahoo Finance](https://au.finance.yahoo.com/). The dataset contains 18 variables of 147 stocks from five major financial indices. Those 18 variables could be further classified into 3 categories. The first categories captures the 5 variables provides the basic background of those stocks which are **Name**, **Symbol**, **Market**, **Sector**, **Industry**. The second and third categories provide some measurement of the value and risk which are related to the stocks. The further description of those variables are shown in the table below: 

| Names         |abbreviation| Description         | 
| :------------ |:-----------|:--------------------|
| Market capitalization:  | intra_day| How much a company is worth as determined by the stock market.  | 
| Enterprise value:  |ent_value| A measure of a company's total value | 
| Trailing P/E:  | trail_pe|  Price to Earning Ratio based on the earnings per share over the previous 12 months.   |
| Forward P/E ratio:  | for_pe|  Estimate further earnings per share in the next 12 months. | 
| PEG ratio:  | peg | Enhances the P/E ratio by adding the expected earnings growth into calculation. | 
| P/S ratio:  | ttm | Price to Sales ratio, a valuation ratio by comparing a company’s stock price to its revenues | 
| P/B ratio:  |  mrq| Price to Book ratio is a measurement of the market's valuation of a company relative to its book value. |
| Enterprise value-to-revenue: |  rev | Also refers as the EV/R, it measures the value of a stock that compares a company's enterprise value to its revenue.| 
| EV/EBITDA | ebitda  | Enterprise value to earnings before interest, taxed, depreciation and amortization ratio compares the value of a company, debt included to the company's cash earnings less non-cash expenses.  | 
| Total ESG risk score: | tot_risk  |The overall rating scores based on the Morningstar Sustainability Rating systems.  | 
| Environmental Risk Score: | envir_risk | Evaluation scores of the portfolios performance when they meet the environmental challenges. | 
| Social Risk Score: | social_risk  |Evaluation scores of the portfolios performance when they meet the social challenges. | 
| Governance Risk Score: | gover_risk  |Evaluation scores of the portfolios performance when they meet the governance challenges. | 


```{r}
summary(stocks)
```

## Description of the variables related to the value of stocks:
- Market capitalization refers to how much a company is worth as determined by the stock market. It is defined as the total market value of all outstanding shares. To calculate a company's market cap, multiply the number of outstanding shares by the current market value of one share. Companies are typically divided according to market capitalization: large-cap (\$10 billion or more), mid-cap (\$2 billion to \$10 billion), and small-cap ($300 million to \$2 billion). Enterprise value includes in its calculation the market capitalization of a company but also short-term and long-term debt as well as any cash on the company's balance sheet. Enterprise value is used as the basis for many financial ratios that measure the performance of a company.
- Enterprise value (EV) is a measure of a company's total value, often used as a more comprehensive alternative to equity market capitalization.
- Trailing P/E is calculated by dividing the current market value, or share price, by the earnings per share over the previous 12 months.
- The forward P/E ratio estimates a company's likely earnings per share for the next 12 months.
- The PEG ratio enhances the P/E ratio by adding in expected earnings growth into the calculation. The PEG ratio is considered to be an indicator of a stock's true value, and similar to the P/E ratio, a *lower PEG may indicate that a stock is undervalued*.
- The P/S ratio is a key analysis and valuation tool that shows *how much investors are willing to pay per dollar of sales for a stock.* The P/S ratio is typically calculated by dividing the stock price by the underlying company's sales per share.A low ratio could imply the stock is undervalued while a ratio that is higher-than-average could indicate that the stock is overvalued.
- The P/B ratio measures the market's valuation of a company relative to its book value.*The market value of equity is typically higher than the book value of a company.* P/B ratio is used by value investors to identify potential investments. P/B ratios under 1 are typically considered solid investments.
- The enterprise value-to-revenue (EV/R) multiple helps compares a company’s revenues to its enterprise value. *The lower the better, in that, a lower EV/R multiple signals a company is undervalued.*
- The enterprise value to earnings before interest, taxes, depreciation, and amortization ratio (EV/EBITDA) compares the value of a company—debt included—to the company’s cash earnings less non-cash expenses. The EV/EBITDA metric is a popular valuation tool that helps investors compare companies in order to make an investment decision. EV calculates a company's total value or assessed worth, while EBITDA measures a company's overall financial performance and profitability. Typically, when evaluating a company, *an EV/EBITDA value below 10 is seen as healthy*. It's best to use the EV/EBITDA metric when comparing companies within the same industry or sector.

```{r, eval=FALSE}
stocks %>% 
  dplyr::filter(ebitda<10) %>% 
  ggplot(aes(ebitda, ebitda)) + 
  geom_boxplot() + 
  facet_wrap(~Industry)
```

# Analysis 

## Preliminary Analysis 

Before we start our Principal Components Analysis, we will firstly tidy our orginal dataset by removing the missing variables and further figure out any other features. 

By summarising orginal variables, we could notice that the initial 147 variables have up to 102 missing value.

```{r sum_tab}
sum_tab<-stocks_ori%>%
   select(-Name,-Symbol,-Market,-Sector,-Industry)%>%
   summary(stocks_ori)
```

| Names | Min |Median|Mean |Max |NA | 
| :---- |:----|:-----|:----|:---|:--|
| intra_day |-2|63 |95065|5110000|NA|
| ent_value |-264|70|85683|5130000|NA|
| trail_pe |0.48|20.11|43.62	|1479.29| 18|
| for_pe|3.59|19.92|43.04|1044.81	| 80
| peg |-62.380|2.405|15.223|713.670|81|
| ttm |0.9|2.8|9.941|548.150|17|
| mrq |0.1|5.4|174.16|11765.96|10|
| rev |-27.720|2.875|9.827|5411.160|17|
| ebitda |-465.460|13.765|19.461|1117.510|23|
| tot_risk|11|23|25.39|75|13|
| envir_risk |0|4|6.731|62| 13|
| social_risk |3|10|11.4|88|13|
| gover_risk |3|8 |9.343|80|13|

In the meanwhile, the summary table provided above could show us the information about the ourliers. Most of the variables we have here, they all have the really small median and mean, but a extremely high maximum value as well. We could say that the extremely value will definitely dominate our Principle component analysis. And here are the outliers we get:

- outliers in `intra_day` and `ent_value`: MSFT & AAPL
- outliers in `trail_pe`: TSLA
- outliers in `for_pe`: ILMN & TSLA
- outliers in `peg`: DIS, VZ, KO, MMM, CVX, PCAR, CAT, XOM
- outliers in `ttm`: ILMN, V
- outliers in `mrq`: TSLA
- outliers in `rev`: ILMN, V
- outliers in `ebitda`: INTU, ILMN, TSLA, NKE


We will generate a new dataset **stocks** by removing the missing value and conduct our following analysis based on our new dataset. 
```{r stocks}
stocks <- na.omit(stocks_ori)
```

## Principle Component Analysis

### Value Analysis 

Based on the preliminary analysis we have above, besides of the missing value removement, what we also need to do is the outliers removement. Since our variables are measured in the different unit, after removing the high influential values, we will standardised our data by using the **scale.** function in R. Biplot could visualise the data by selecting two principal components. The graphs and interpretation will also be provided below. 

```{r value}
issuer<-stocks%>%
  select(Symbol,intra_day,ent_value,trail_pe,for_pe,peg,ttm,mrq,rev,ebitda)
df <- issuer[!(issuer$Symbol %in% c("MSFT", "AAPL", "TSLA", "ILMN", "DIS", "VZ", "KO", "MMM", "CVX", "PCAR", "CAT", "XOM", "V", "INTU", "NKE")),]
```

```{r pca_value}
pca_value<-df%>%
  select_if(is.numeric)%>%
  prcomp(scale.=TRUE)
rownames(pca_value$x)<-pull(df,Symbol)
biplot(pca_value,xlim=c(-0.6,0.3),cex=0.8)
```


The limitation 

```{r lim}
summary(pca_value)
screeplot(pca_value, type = "lines")
```

```{r, eval=FALSE}
stocks %>% filter(Industry == "Technology")
```

## Value analysis(All)

```{r}
all_value <- stocks %>% 
  select(intra_day:ebitda) %>%
  prcomp(scale. = TRUE)
summary(all_value)
rownames(all_value$x) <- pull(stocks, Symbol)
biplot(all_value)
#all_value$rotation
screeplot(all_value, type = "lines")
```




### Risk 
```{r risk-df}
risk <- subset(stocks[(stocks$Symbol %in% df$Symbol),], select = c("Symbol", "tot_risk", "envir_risk", "social_risk", "gover_risk"))
#view(risk)
```

```{r first-check, eval=FALSE}
d <- apply(cbind(risk$envir_risk, risk$social_risk, risk$gover_risk), 1, sum)
all(risk$tot_risk == d)
```

```{r risk data, eval=FALSE}
# checking if total esg risk score = environmrnt + social + government 
risk_tesg <- risk[risk$tot_risk == d,]
d2 <- apply(cbind(risk_tesg$envir_risk, risk_tesg$social_risk, risk_tesg$gover_risk), 1, sum)
all(risk_tesg$tot_risk == d2)
#head(risk_tesg)
nrow(risk_tesg)
```

```{r pca-risk, fig.height=5}
pca_risk <- risk_tesg %>% select_if(is.numeric) %>% prcomp(scale. = TRUE)
rownames(pca_risk$x) <- pull(risk_tesg, Symbol)
biplot(pca_risk, ylim = c(-0.5, 0.3),  cex = 0.8)
screeplot(pca_risk, type = "lines")
```

```{r dat-cluster}
dat <- stocks[(stocks$Symbol %in% df$Symbol),]
d <- dat %>% select_if(is.numeric) %>% scale %>% dist 
```

Prefer using Ward's method..

```{r Ward's}
hc_w <- hclust(d, method = "ward.D2")
hc_w$labels <- dat$Symbol
plot(hc_w, cex = 0.5)
rect.hclust(hc_w, k = 3)
```

```{r memb_w}
memb_three_w <- cutree(hc_w, k = 3)
```

```{r complete}
hc_c <- hclust(d, method = "complete")
hc_c$labels <- dat$Symbol
plot(hc_c, cex = 0.5)
rect.hclust(hc_c, k = 3)
```

```{r memb-complete}
memb_three_c <- cutree(hc_c, k = 3) 
```

```{r average}
hc_al <- hclust(d, method = "average")
hc_al$labels <- dat$Symbol
plot(hc_al, cex = 0.5)
rect.hclust(hc_al, k = 3)
```

```{r memb_al}
memb_three_al <- cutree(hc_al, k = 3)
```

```{r centroid}
hc_cm <- hclust(d, method = "centroid")
hc_cm$labels <- dat$Symbol
plot(hc_cm, cex = 0.5)
rect.hclust(hc_cm, k = 3)
```

```{r memb_cm}
memb_three_cm <- cutree(hc_cm, k = 3)
```

```{r}
adjustedRandIndex(memb_three_w, memb_three_c)
adjustedRandIndex(memb_three_w, memb_three_al)
adjustedRandIndex(memb_three_w, memb_three_cm)
```


